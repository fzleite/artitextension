"use strict";

/** ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  *********************                                                                                ***********************
 *  *********************               CONFIGURAÇÕES PARA USO DA PAGINA DE USUARIO                      ***********************
 *  *********************                                                                                ***********************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ************************************************************************************************************************* */

const interval = {
    // Constantes de Tempo
    SECOND         : (1000),
    TWO_SECONDS    : (1000 * 2),
    QUARTER_MINUTE : (1000 * 15),
    HALF_MINUTE    : (1000 * 30),
    MINUTE         : (1000 * 60),
    FIVE_MINUTE    : (1000 * 60 * 5),
    QUARTER        : (1000 * 60 * 15),
    HALF_HOUR      : (1000 * 60 * 30),
    HOUR           : (1000 * 60 * 60),
    SIX_HOURS      : (1000 * 60 * 60 * 6),
    HALF_DAY       : (1000 * 60 * 60 * 12),
    DAY            : (1000 * 60 * 60 * 24)
}

// *************************************************
// Constantes da aplicação
// *************************************************
const userPage = {

    // Informações de localização de elementos
    location : {
        backgroundPage   : "background",
        contentPage      : "contentPage",
        popupPage        : "popupPage"
    },

    // Tipos de Request
    request : {
        update            : "updateMessage",
        setMessage        : "setMessage",
        defaultIcon       : "defaultIcon",
        alertIcon         : "alertIcon",
        disconnect        : "disconnectApp",
        setup             : "setup",
        NONE              : "none"
    },

}

// *************************************************
// Constantes da aplicação
// *************************************************
const app = {
    firebase : {
        mainDB : "users/",
        adminDB : "admin/"
    }
}


/** ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  *********************                                                                                ***********************
 *  *********************                               BLOCO DE LISTENERS                               ***********************
 *  *********************                                                                                ***********************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ************************************************************************************************************************* */

/**
 * Tira o evento de submut do formulario
 */
document.getElementById("frm").addEventListener('submit', function(event){
    event.preventDefault();
})


/**
 * Adiciona evento no botão Enviar do forma de email
 */
document.getElementById("btSend").addEventListener('click', function(){
    let nome = document.getElementById("nomecompleto");
    let email = document.getElementById("email");
    let mask = /\w[a-z]@(artit\.com\.br)$/;

    if( !mask.test( email.value ) ){
        setMessage("Email invalido. Lembre-se de usar seu email valido da Art IT");
    }else{
        localStorage.setItem("username", email.value);        
        localStorage.setItem("fullName", nome.value);

        messageTo( userPage.location.backgroundPage,
                   userPage.request.setup );
        
        window.close();
    }
});

/**
 * Adiciona evento no botão Enviar do forma de email
 */
document.getElementById("btCancel").addEventListener('click', function(){
   window.close(); 
});

/** ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  *********************                                                                                ***********************
 *  *********************                          BLOCO DE FUNÇÕES DA PAGINA                            ***********************
 *  *********************                                                                                ***********************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ************************************************************************************************************************* */

/**
 * Informa mensagem de erro na tela
 */
function setMessage(message) {
    let oAlert = document.getElementById("notificationAlert");

    oAlert.style.display = "block"
    oAlert.textContent = message;
}


/**
 * Verifica se o usuario foi setado e fecha a aba caso positivo
 */
function checkUser(){
    let user = localStorage.getItem("username");

    if( user !== null )
        window.close();
}

// Monitora se o status de definição do usuario foi alterado de tempos em tempos
setInterval( checkUser, interval.TWO_SECONDS );


/**
 * Prepara o fechamento da janela apos 1 minuto e deixa este controle para o background
 */
setTimeout( 
    function(){
      window.close();  
    }, 
    interval.MINUTE
);


/** ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  *********************                                                                                ***********************
 *  *********************                          BLOCO DE FUNÇÕES DO CHROME                            ***********************
 *  *********************                                                                                ***********************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ****************************************************************************************************************************
 *  ************************************************************************************************************************* */

/**
 * Envia mensagem para a aplicação
 */
function messageTo( destinator, request, message ){
    message = ( message ? message : "");
    chrome.runtime.sendMessage( {
        destinator : destinator,
        request : request,
        message : message
    });            
}
